// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Billing {
  id             Int            @id @default(autoincrement())
  subscriptionId Int
  availableFunds Decimal        @default(0) @db.Decimal(12, 2)
  unitPrice      Decimal        @default(0) @db.Decimal(12, 2)
  createdAt      DateTime
  updatedAt      DateTime
  BillingUsage   BillingUsage[]
}

model BillingUsage {
  id         Int      @id @default(autoincrement())
  billing    Billing  @relation(fields: [billingId], references: [id])
  billingId  Int
  /// start of billing period
  startAt    DateTime
  /// end of billing period
  endAt      DateTime
  /// this is a count of uses
  usageCount Int
  /// this is the monetary value of usage
  usage      Decimal  @default(0) @db.Decimal(12, 2)
  createdAt  DateTime
  updatedAt  DateTime

  @@index([billingId], name: "BillingUsage_billingId")
}

model Contacts {
  id                 Int                 @id @default(autoincrement())
  fullName           String
  email              String
  mobile             String
  handle             String
  tenant             Tenants             @relation(fields: [tenantId], references: [id])
  tenantId           Int
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  ContactGroupsLinks ContactGroupLinks[]

  @@index([tenantId], name: "Contacts_tenantId")
}

model ContactGroupLinks {
  id             Int           @id @default(autoincrement())
  contactGroups  ContactGroups @relation(fields: [contactGroupId], references: [id])
  contactGroupId Int
  contacts       Contacts      @relation(fields: [contactId], references: [id])
  contactId      Int
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([contactGroupId], name: "ContactGroupLinks_contactGroupId")
  @@index([contactId], name: "ContactGroupLinks_contactId")
}

model ContactGroups {
  id                Int                 @id @default(autoincrement())
  name              String
  description       String
  tenant            Tenants             @relation(fields: [tenantId], references: [id])
  tenantId          Int
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  ContactGroupLinks ContactGroupLinks[]

  @@index([tenantId], name: "ContactGroups_tenantId")
}

model Invoices {
  id          Int      @id @default(autoincrement())
  name        String
  description String
  orders      Orders   @relation(fields: [orderId], references: [id])
  orderId     Int
  tenant      Tenants  @relation(fields: [tenantId], references: [id])
  tenantId    Int
  amount      Decimal  @default(0) @db.Decimal(12, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId], name: "Invoices_tenantId")
}

model LookupCurrencies {
  id                   Int             @id @default(autoincrement())
  // currency iso code e.g. ZAR
  code                 String
  /// compared to US $
  dollar_exchange_rate Decimal         @default(1) @db.Decimal(7, 4)
  updateAt             DateTime        @updatedAt
  Subscriptions        Subscriptions[]
}

model Notifications {
  id                     Int                      @id @default(autoincrement())
  templates              Templates                @relation(fields: [templateId], references: [id])
  templateId             Int
  userId                 Int
  entity                 String
  entityId               Int
  notificationType       NotificationTypes        @default(GENERAL)
  serviceType            ServiceTypes             @default(EMAIL)
  status                 StatusTypes              @default(NEW)
  statusMessage          String                   @default("NEW")
  retryCount             Int                      @default(0)
  useSystemPreferences   Boolean                  @default(false)
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  NotificationContent    NotificationContent[]
  NotificationRecipients NotificationRecipients[]
}

model NotificationContent {
  id             Int           @id @default(autoincrement())
  notifications  Notifications @relation(fields: [notificationId], references: [id])
  notificationId Int
  contentType    ContentTypes  @default(HTML)
  content        String        @db.Text()
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([notificationId], name: "NotificationContent_notificationId")
}

model NotificationRecipients {
  id             Int           @id @default(autoincrement())
  notifications  Notifications @relation(fields: [notificationId], references: [id])
  notificationId Int
  userId         Int
  contactId      Int
  copyType       CopyTypes     @default(TO)
  fullName       String
  email          String
  mobile         String
  handle         String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([notificationId], name: "NotificationRecipients_notificationId")
}

model Orders {
  id           Int            @id @default(autoincrement())
  name         String
  description  String         @db.Text
  unitPrice    Decimal        @default(1) @db.Decimal(7, 4)
  volume       Int
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  ProductStock ProductStock[]
  Invoices     Invoices[]
  Tenants      Tenants?       @relation(fields: [tenantsId], references: [id])
  tenantsId    Int?
}

model Products {
  id             Int              @id @default(autoincrement())
  name           String
  description    String           @db.Text
  unitPrice      Decimal          @default(1) @db.Decimal(7, 4)
  currency       Currencies       @default(ZAR)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  ProductBundles ProductBundles[]
  ProductStock   ProductStock[]
  Subscriptions  Subscriptions[]
}

model ProductBundles {
  id          Int      @id @default(autoincrement())
  products    Products @relation(fields: [productId], references: [id])
  productId   Int
  name        String
  description String   @db.Text
  unitPrice   Decimal  @default(1) @db.Decimal(7, 4)
  volume      Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([productId], name: "ProductBundles_productId")
}

model ProductStock {
  id        Int      @id @default(autoincrement())
  products  Products @relation(fields: [productId], references: [id])
  productId Int
  orders    Orders   @relation(fields: [orderId], references: [id])
  orderId   Int
  tenants   Tenants  @relation(fields: [tenantId], references: [id])
  tenantId  Int
  bundle    Boolean  @default(false)
  bundleId  Int      @default(0)
  volume    Int      @default(0)
  createdAt DateTime @default(now())
  updateAt  DateTime @updatedAt

  @@index([productId], name: "ProductStock_productId")
}

model Services {
  id               Int          @id @default(autoincrement())
  userId           Int
  serviceType      ServiceTypes @default(SMS)
  messageType      MessageTypes @default(SMS_SIMPLE)
  providerType     ProviderType @default(INFOBIP)
  providerRequest  String       @db.Text
  providerResponse String       @db.Text
  status           StatusTypes  @default(NEW)
  statusMessage    String       @default("NEW")
  retryCount       Int          @default(0)
  jobId            String       @default("")
  jobStatus        JobStatus    @default(NEW)
  request          String       @db.Text
  response         String       @db.Text
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

model Subscriptions {
  id         Int              @id @default(autoincrement())
  products   Products         @relation(fields: [productId], references: [id])
  productId  Int
  currency   LookupCurrencies @relation(fields: [currencyId], references: [id])
  currencyId Int
  users      Users            @relation(fields: [userId], references: [id])
  userId     Int
  /// what each unit costs e.g. email = 0,001
  unitPrice  Decimal          @default(0) @db.Decimal(7, 4)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@index([productId], name: "Subscriptions_productId")
  @@index([currencyId], name: "Subscriptions_currencyId")
  @@index([userId], name: "Subscriptions_userId")
}

model SystemSettings {
  id        Int      @id @default(autoincrement())
  tenants   Tenants  @relation(fields: [tenantId], references: [id])
  tenantId  Int
  module    String
  setting   String
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId], name: "SystemSettings_tenantId")
}

model Templates {
  id            Int             @id @default(autoincrement())
  tenants       Tenants         @relation(fields: [tenantId], references: [id])
  tenantId      Int
  name          String
  htmlBody      String          @db.Text()
  textBody      String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  Notifications Notifications[]

  @@index([tenantId], name: "NotificationTemplates_tenantId")
}

model Tenants {
  id              Int               @id @default(autoincrement())
  name            String            @default("")
  domain          String
  currency        Currencies        @default(ZAR)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  Contacts        Contacts[]
  ContactGroups   ContactGroups[]
  Invoices        Invoices[]
  Orders          Orders[]
  ProductStock    ProductStock[]
  Settings        SystemSettings[]
  Templates       Templates[]
  UserTenantLinks UserTenantLinks[]
}

model UniqueLinks {
  id        Int      @id @default(autoincrement())
  users     Users    @relation(fields: [userId], references: [id])
  userId    Int
  linkId    String   @unique
  linkType  LinkType
  urlPath   String
  expiry    DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId], name: "UniqueLinks_userId")
}

model Users {
  id              Int               @id @default(autoincrement())
  email           String            @unique
  name            String
  surname         String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  UserSecurity    UserSecurity?
  UserRole        UserRole          @default(USER)
  UniqueLinks     UniqueLinks[]
  Subscriptions   Subscriptions[]
  UserPreferences UserPreferences[]
  UserTenantLinks UserTenantLinks[]
}

model UserPreferences {
  id        Int      @id @default(autoincrement())
  users     Users    @relation(fields: [userId], references: [id])
  userId    Int
  setting   String
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId], name: "UserPreferences_userId")
}

model UserTenantLinks {
  id        Int      @id @default(autoincrement())
  users     Users    @relation(fields: [userId], references: [id])
  userId    Int
  tenants   Tenants  @relation(fields: [tenantId], references: [id])
  tenantId  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId], name: "UserTenantLinks_userId")
  @@index([tenantId], name: "UserTenantLinks_tenantId")
}

model UserSecurity {
  id           Int      @id @default(autoincrement())
  password     String
  refreshToken String?  @unique
  user         Users    @relation(fields: [userId], references: [id])
  userId       Int      @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId], name: "UserSecurity_userId")
}

enum Currencies {
  AUD
  EUR
  GBP
  USD
  ZAR
}

enum ContentTypes {
  HTML
  TEXT
}

enum CopyTypes {
  TO
  CC
  BCC
}

enum JobStatus {
  FAILED
  NEW
  PROCESSING
  SUCCESS
}

enum MessageTypes {
  EMAIL_ADVANCED
  EMAIL_DELIVERY_REPORT
  EMAIL_LOGS
  EMAIL_SIMPLE
  OTP
  SMS_SIMPLE
  SMS_ADVANCED
}

enum NotificationTypes {
  ACCOUNT_OTP
  ACCOUNT_PASSWORD_RESET
  ACCOUNT_VALIDATION
  GENERAL
  ENTITY_NEW
}

enum ProviderType {
  ELMNTRY
  INFOBIP
  SMTP
}

enum ServiceTypes {
  APP
  EMAIL
  PUSH
  SMS
  VIBER
  VOICE
  WHATSAPP
}

enum StatusTypes {
  NEW
  PROCESSING
  COMPLETE
  FAILED
}

enum LinkType {
  RESET_PASSWORD
}

enum UserRole {
  ADMIN // admin
  CLIENTADMIN // client admin
  USER // client user
}
